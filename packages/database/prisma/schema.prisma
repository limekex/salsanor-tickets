// prisma/schema.prisma
datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

generator client {
  provider = "prisma-client-js"
}

enum UserRole {
  ADMIN           // Global admin - can manage all organizers
  ORGANIZER       // Deprecated - use ORG_ADMIN instead
  ORG_ADMIN       // Organizer admin - can manage their organizer's periods/tracks
  ORG_FINANCE     // Organizer finance - can view financial reports for their organizer
  ORG_CHECKIN     // Organizer check-in staff - can check in for their organizer's events
  INSTRUCTOR      // Can view participant lists
  CHECKIN         // Global check-in staff
  STAFF           // General staff
  PARTICIPANT     // Regular participant
}

enum RegistrationStatus {
  DRAFT
  PENDING_PAYMENT
  ACTIVE
  WAITLIST
  CANCELLED
  REFUNDED
}

enum TrackRole {
  LEADER
  FOLLOWER
  ANY
}

enum OrderStatus {
  DRAFT
  PENDING
  PAID
  CANCELLED
  REFUNDED
}

enum PaymentProvider {
  STRIPE
  VIPPS
}

enum PaymentStatus {
  REQUIRES_ACTION
  SUCCEEDED
  FAILED
  REFUNDED
}

enum EmailProviderType {
  BREVO
  RESEND
  SENDGRID
  SES
  SMTP
}

enum EmailCategory {
  TRANSACTIONAL
  NOTIFICATION
  MARKETING
  SYSTEM
}

enum EmailStatus {
  QUEUED
  SENDING
  SENT
  DELIVERED
  OPENED
  CLICKED
  BOUNCED
  FAILED
}

enum WaitlistStatus {
  ON_WAITLIST
  OFFERED
  EXPIRED
  ACCEPTED
  REMOVED
}

enum TicketStatus {
  ACTIVE
  VOIDED
}

enum CheckInType {
  PERIOD_ENTRY
  SESSION_ENTRY
}

model UserAccount {
  id            String   @id @default(uuid())
  supabaseUid   String   @unique
  email         String   @unique
  createdAt     DateTime @default(now())
  roles         UserAccountRole[]
  personProfile PersonProfile?
  auditLogs     AuditLog[]
}

model UserAccountRole {
  id           String   @id @default(uuid())
  userId       String
  role         UserRole
  organizerId  String?  // Optional: for ORGANIZER role scoping
  createdAt    DateTime @default(now())
  user         UserAccount @relation(fields: [userId], references: [id])
  organizer    Organizer? @relation(fields: [organizerId], references: [id])
  @@unique([userId, role, organizerId])
  @@index([organizerId])
}

model PersonProfile {
  id          String   @id @default(uuid())
  userId      String?  @unique
  firstName   String
  lastName    String
  phone       String?
  email       String
  photoUrl    String?  // Profile photo URL for membership cards
  preferredLanguage String @default("no") // Email language preference: 'no' or 'en'
  
  // Physical address
  streetAddress String?
  postalCode    String?
  city          String?
  country       String @default("Norway")
  
  // GDPR and consent
  gdprConsentAt         DateTime? // When user accepted GDPR/privacy policy
  touConsentAt          DateTime? // When user accepted Terms of Use
  reginorMarketingConsent Boolean @default(false) // RegiNor marketing emails
  organizerMarketingConsent Boolean @default(false) // Organizer marketing emails
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  memberships Membership[]
  registrations Registration[]
  eventRegistrations EventRegistration[]
  tickets     Ticket[]
  eventTickets EventTicket[]
  orders      Order[]
  user        UserAccount? @relation(fields: [userId], references: [id])
  @@index([email])
}

model Organizer {
  id            String   @id @default(uuid())
  slug          String   @unique
  name          String
  description   String?
  logoUrl       String?
  website       String?
  contactEmail  String?
  city          String?
  country       String   @default("Norway")
  timezone      String   @default("Europe/Oslo")
  
  // Business Registration
  organizationNumber String?  @unique // Norwegian org.nr (9 digits)
  vatRegistered     Boolean  @default(false)
  companyType       String?  // AS, ASA, ENK, etc.
  legalName         String?  // Official registered name
  
  // Tax & Accounting
  mvaRate              Decimal  @default(0) // 0, 12, 15, or 25
  mvaReportingRequired Boolean  @default(false)
  accountingSystem     String?  // TRIPLETEX, FIKEN, VISMA, etc.
  fiscalYearStart      DateTime?
  
  // Invoice Configuration
  invoicePrefix        String   @default("INV")
  nextInvoiceNumber    Int      @default(1)
  invoiceEmail         String?
  invoiceAddress       Json?
  bankAccount          String?
  swiftBic             String?
  
  // Stripe Connect
  stripeConnectAccountId   String?  @unique
  stripeOnboardingComplete Boolean  @default(false)
  stripeChargesEnabled     Boolean  @default(false)
  stripePayoutsEnabled     Boolean  @default(false)
  stripeFeePercentage      Decimal  @default(2.5)
  stripeFixedFeeCents      Int      @default(0)
  
  // Membership Product
  membershipEnabled        Boolean  @default(false)
  membershipSalesOpen      Boolean  @default(true)
  membershipDescription    String?
  nextMemberNumber         Int      @default(1) // Auto-increment for member numbers
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  periods       CoursePeriod[]
  events        Event[]
  memberships   Membership[]
  membershipTiers MembershipTier[]
  userRoles     UserAccountRole[]
  invoices      Invoice[]
  creditNotes   CreditNote[]
  emailSettings EmailSettings?
  emailTemplates EmailTemplate[]
  emailLogs     EmailLog[]
  
  @@index([slug])
}

model MembershipTier {
  id                  String   @id @default(uuid())
  organizerId         String
  name                String   // "Normal", "Supporting", "Family", etc.
  slug                String   // "normal", "supporting", "family"
  description         String?
  priceCents          Int      // Annual price (includes MVA if mvaEnabled is true)
  benefits            Json?    // Array of benefit strings
  discountPercent     Decimal  @default(0) // Discount percentage for courses/events
  priority            Int      @default(0) // Display order
  enabled             Boolean  @default(true)
  validationRequired  Boolean  @default(false) // If true, org admin must approve registrations
  mvaEnabled          Boolean  @default(true) // If true, price includes MVA
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt
  
  organizer       Organizer @relation(fields: [organizerId], references: [id], onDelete: Cascade)
  memberships     Membership[]
  
  @@unique([organizerId, slug])
  @@index([organizerId, enabled])
}

model CoursePeriod {
  id            String   @id @default(uuid())
  organizerId   String
  code          String   @unique // e.g., "TB-2026-P1"
  name          String
  city          String
  locationName  String?
  startDate     DateTime
  endDate       DateTime
  salesOpenAt   DateTime
  salesCloseAt  DateTime
  timezone      String   @default("Europe/Oslo")
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  organizer     Organizer @relation(fields: [organizerId], references: [id])
  tracks        CourseTrack[]
  pairGroups    PairGroup[]
  registrations Registration[]
  discountRules DiscountRule[]
  orders        Order[]
  tickets       Ticket[]
  @@index([organizerId])
  @@index([startDate, endDate])
}

model CourseTrack {
  id             String   @id @default(uuid())
  periodId       String
  title          String
  levelLabel     String?  // "Intro", "L2", etc.
  weekday        Int      // 1=Mon..7=Sun
  timeStart      String   // "19:00"
  timeEnd        String   // "20:15"
  capacityTotal  Int
  capacityLeaders Int?    // optional split capacity
  capacityFollowers Int?  // optional split capacity
  rolePolicy     TrackRole @default(ANY)
  waitlistEnabled Boolean @default(true)
  priceSingleCents Int
  pricePairCents   Int?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  period         CoursePeriod @relation(fields: [periodId], references: [id])
  sessions       TrackSession[]
  registrations  Registration[]
  @@index([periodId])
}

model TrackSession {
  id        String   @id @default(uuid())
  trackId   String
  startsAt  DateTime
  endsAt    DateTime
  track     CourseTrack @relation(fields: [trackId], references: [id])
  checkIns  CheckIn[]
  @@index([trackId, startsAt])
}

model PairGroup {
  id        String   @id @default(uuid())
  periodId  String
  createdAt DateTime @default(now())
  period    CoursePeriod @relation(fields: [periodId], references: [id])
  members   Registration[]
  @@index([periodId])
}

model Registration {
  id            String   @id @default(uuid())
  periodId      String
  trackId       String
  personId      String
  status        RegistrationStatus @default(DRAFT)
  chosenRole    TrackRole @default(ANY) // participant choice: leader/follower/any
  pairGroupId   String?
  orderId       String?
  
  // Cancellation tracking
  cancelledAt         DateTime?
  cancellationReason  String?
  refundAmount        Int?      // Amount refunded in cents
  refundPercentage    Int?      // 0-100
  stripeRefundId      String?   // Stripe refund ID for tracking
  
  waitlist      WaitlistEntry?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  period        CoursePeriod @relation(fields: [periodId], references: [id])
  track         CourseTrack  @relation(fields: [trackId], references: [id])
  person        PersonProfile @relation(fields: [personId], references: [id])
  pairGroup     PairGroup? @relation(fields: [pairGroupId], references: [id])
  order         Order? @relation(fields: [orderId], references: [id])
  @@unique([trackId, personId]) // prevent duplicates in same track
  @@index([periodId, trackId])
}

model WaitlistEntry {
  id            String   @id @default(uuid())
  registrationId String @unique
  status        WaitlistStatus @default(ON_WAITLIST)
  offeredUntil  DateTime?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  registration  Registration @relation(fields: [registrationId], references: [id])
}

model Order {
  id          String   @id @default(uuid())
  periodId    String?  // Nullable for non-period orders (events, memberships)
  purchaserPersonId String
  orderNumber String?  @unique // Human-readable order number
  status      OrderStatus @default(DRAFT)
  currency    String   @default("NOK")
  orderType   OrderType @default(COURSE_PERIOD) // COURSE_PERIOD, EVENT, MEMBERSHIP
  
  // Pricing breakdown
  subtotalCents              Int  // Base price before MVA
  discountCents              Int  // Discounts applied
  subtotalAfterDiscountCents Int  // subtotalCents - discountCents
  
  // MVA/VAT tracking
  mvaRate         Decimal  @default(0)    // 0.00, 12.00, 15.00, or 25.00
  mvaCents        Int      @default(0)    // Calculated MVA amount
  totalCents      Int                     // subtotalAfterDiscountCents + mvaCents
  
  // Stripe payment tracking
  stripePaymentIntentId String?
  stripeCheckoutSessionId String?
  
  pricingSnapshot Json // store applied rules + breakdown for audit
  providerCheckoutRef String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  period      CoursePeriod? @relation(fields: [periodId], references: [id])
  purchaser   PersonProfile @relation(fields: [purchaserPersonId], references: [id])
  registrations Registration[]
  eventRegistrations EventRegistration[]
  memberships Membership[]
  payments    Payment[]
  invoice     Invoice?
  @@index([periodId, status])
}

enum OrderType {
  COURSE_PERIOD
  EVENT
  MEMBERSHIP
}

model Payment {
  id          String @id @default(uuid())
  orderId     String
  provider    PaymentProvider
  providerPaymentRef String
  status      PaymentStatus
  amountCents Int
  currency    String @default("NOK")
  rawPayload  Json
  createdAt   DateTime @default(now())
  order       Order @relation(fields: [orderId], references: [id])
  @@index([orderId])
}

model Ticket {
  id          String   @id @default(uuid())
  periodId    String
  personId    String
  status      TicketStatus @default(ACTIVE)
  qrTokenHash String   @unique // store hash only
  issuedAt    DateTime @default(now())
  period      CoursePeriod @relation(fields: [periodId], references: [id])
  person      PersonProfile @relation(fields: [personId], references: [id])
  checkIns    CheckIn[]
  @@unique([periodId, personId]) // one ticket per person per period
  @@index([periodId])
}

model CheckIn {
  id          String   @id @default(uuid())
  ticketId    String
  type        CheckInType
  sessionId   String?
  scannedByUserId String?
  scannedAt   DateTime @default(now())
  meta        Json?
  ticket      Ticket @relation(fields: [ticketId], references: [id])
  session     TrackSession? @relation(fields: [sessionId], references: [id])
  @@index([ticketId, scannedAt])
}

model Membership {
  id                String   @id @default(uuid())
  personId          String
  organizerId       String
  tierId            String   // Reference to MembershipTier
  memberNumber      String?
  validFrom         DateTime
  validTo           DateTime
  status            MembershipStatus @default(ACTIVE)
  source            String   @default("IMPORT") // IMPORT, MANUAL, PURCHASE
  autoRenew         Boolean  @default(false)
  orderId           String?  // If purchased through platform
  verificationToken String?  @unique // For QR code verification
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  
  person       PersonProfile @relation(fields: [personId], references: [id])
  organizer    Organizer @relation(fields: [organizerId], references: [id])
  tier         MembershipTier @relation(fields: [tierId], references: [id])
  order        Order? @relation(fields: [orderId], references: [id])
  
  @@unique([personId, organizerId, validFrom])
  @@index([personId, validTo])
  @@index([organizerId, status])
  @@index([tierId])
  @@index([verificationToken])
}

enum MembershipStatus {
  ACTIVE
  EXPIRED
  CANCELLED
  PENDING_PAYMENT
}

model Event {
  id              String   @id @default(uuid())
  organizerId     String
  slug            String
  title           String
  description     String?
  eventType       EventType @default(SINGLE)
  
  // Timing
  startDateTime   DateTime
  endDateTime     DateTime?
  timezone        String   @default("Europe/Oslo")
  
  // Location
  locationName    String?
  locationAddress String?
  city            String?
  
  // Sales
  salesOpenAt     DateTime
  salesCloseAt    DateTime
  
  // Capacity
  capacityTotal   Int
  requiresRole    Boolean  @default(false) // If true, need leader/follower
  
  // Pricing
  basePriceCents  Int
  memberPriceCents Int?    // Special price for members
  
  // Settings
  status          EventStatus @default(DRAFT)
  published       Boolean  @default(false)
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  organizer       Organizer @relation(fields: [organizerId], references: [id])
  registrations   EventRegistration[]
  tickets         EventTicket[]
  
  @@unique([organizerId, slug])
  @@index([organizerId, startDateTime])
  @@index([published, startDateTime])
}

enum EventType {
  SINGLE      // One-time event
  RECURRING   // Repeating event (e.g., weekly social)
}

enum EventStatus {
  DRAFT
  PUBLISHED
  CANCELLED
  COMPLETED
}

model EventRegistration {
  id          String   @id @default(uuid())
  eventId     String
  personId    String
  orderId     String?
  chosenRole  TrackRole?
  status      RegistrationStatus @default(PENDING_PAYMENT)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  event       Event @relation(fields: [eventId], references: [id])
  person      PersonProfile @relation(fields: [personId], references: [id])
  order       Order? @relation(fields: [orderId], references: [id])
  
  @@unique([eventId, personId])
  @@index([eventId, status])
  @@index([personId])
}

model EventTicket {
  id          String   @id @default(uuid())
  eventId     String
  personId    String
  qrTokenHash String   @unique
  status      TicketStatus @default(ACTIVE)
  checkedInAt DateTime?
  createdAt   DateTime @default(now())
  
  event       Event @relation(fields: [eventId], references: [id])
  person      PersonProfile @relation(fields: [personId], references: [id])
  
  @@unique([eventId, personId])
  @@index([personId])
}

model DiscountRule {
  id          String   @id @default(uuid())
  periodId    String
  code        String   // internal code e.g. "MULTI_2", "MEMBER_15"
  name        String
  priority    Int      // evaluation order
  enabled     Boolean  @default(true)
  ruleType    String   // e.g. "MULTI_COURSE", "MEMBERSHIP", "PAIR_PRICE", "PROMO_CODE"
  config      Json     // structured config per type
  createdAt   DateTime @default(now())
  period      CoursePeriod @relation(fields: [periodId], references: [id])
  @@unique([periodId, code])
  @@index([periodId, priority])
}

model PaymentConfig {
  id        String   @id @default(uuid())
  provider  PaymentProvider @unique
  enabled   Boolean  @default(false)
  isTest    Boolean  @default(true)
  
  // Standard Stripe API keys (for direct payments)
  secretKey String?  // Encrypted or protected via RLS (Admin only)
  publishableKey String?
  webhookSecret String?
  
  // Stripe Connect platform settings
  useStripeConnect Boolean @default(false)
  platformAccountId String? // Platform's Stripe account ID
  platformFeePercent Decimal @default(0) // Platform commission %
  platformFeeFixed Int @default(0) // Fixed fee in cents per transaction
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

enum InvoiceStatus {
  DRAFT
  SENT
  PAID
  OVERDUE
  CANCELLED
  CREDITED
}

model Invoice {
  id              String   @id @default(uuid())
  invoiceNumber   String   @unique  // Sequential: ORG-PREFIX-0001
  organizerId     String
  orderId         String   @unique
  
  // Customer Information
  customerName    String
  customerEmail   String
  customerOrgNr   String?  // For B2B invoicing
  customerAddress Json?
  
  // Financial Details
  subtotalCents   Int
  mvaRate         Decimal  // 0, 12, 15, or 25
  mvaCents        Int      // Calculated MVA amount
  totalCents      Int      // subtotalCents + mvaCents
  currency        String   @default("NOK")
  
  // Invoice Details
  invoiceDate     DateTime @default(now())
  dueDate         DateTime
  paymentTerms    String   @default("Due upon receipt")
  status          InvoiceStatus @default(DRAFT)
  
  // Payment tracking
  paidAt          DateTime?
  paidAmount      Int?
  
  // Audit
  sentAt          DateTime?
  pdfUrl          String?
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  organizer       Organizer @relation(fields: [organizerId], references: [id])
  order           Order @relation(fields: [orderId], references: [id])
  creditNotes     CreditNote[]
  auditLogs       AuditLog[]
  
  @@index([organizerId, invoiceNumber])
  @@index([invoiceDate])
}

model CreditNote {
  id              String   @id @default(uuid())
  creditNumber    String   @unique
  organizerId     String
  invoiceId       String
  
  reason          String
  amountCents     Int
  mvaCents        Int
  totalCents      Int
  
  issueDate       DateTime @default(now())
  status          String   @default("ISSUED")
  
  createdAt       DateTime @default(now())
  
  organizer       Organizer @relation(fields: [organizerId], references: [id])
  invoice         Invoice @relation(fields: [invoiceId], references: [id])
  
  @@index([organizerId, creditNumber])
}

model AuditLog {
  id          String   @id @default(uuid())
  userId      String?
  entityType  String   // "Order", "Invoice", "Payment", etc.
  entityId    String
  action      String   // "CREATE", "UPDATE", "DELETE", "SEND", "PAID"
  changes     Json     // Before/after snapshot
  ipAddress   String?
  userAgent   String?
  timestamp   DateTime @default(now())
  
  user        UserAccount? @relation(fields: [userId], references: [id])
  invoice     Invoice? @relation(fields: [entityId], references: [id])
  
  @@index([entityType, entityId])
  @@index([timestamp])
  @@index([userId])
}

model EmailProvider {
  id              String   @id @default(uuid())
  provider        EmailProviderType
  apiKey          String?  // Encrypted
  smtpHost        String?
  smtpPort        Int?
  smtpUsername    String?
  smtpPassword    String?  // Encrypted
  isActive        Boolean  @default(true)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}

model EmailSettings {
  id                String   @id @default(uuid())
  organizerId       String?  @unique // null = global settings
  fromName          String
  fromEmail         String
  replyToEmail      String
  enableLogo        Boolean  @default(true)
  enableSignature   Boolean  @default(true)
  signatureHtml     String?  @db.Text
  primaryLanguage   String   @default("no")
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  organizer         Organizer? @relation(fields: [organizerId], references: [id])
}

model EmailTemplate {
  id              String   @id @default(uuid())
  organizerId     String?  // null = global template
  category        EmailCategory
  name            String   // "Order Confirmation"
  slug            String   // "order-confirmation"
  language        String   @default("no")
  subject         String
  preheader       String?  // Preview text
  htmlContent     String   @db.Text
  textContent     String?  @db.Text
  variables       Json     // Available variables for this template
  isActive        Boolean  @default(true)
  version         Int      @default(1)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  organizer       Organizer? @relation(fields: [organizerId], references: [id])
  emailLogs       EmailLog[]
  
  @@unique([organizerId, slug, language])
  @@index([category, isActive])
}

model EmailLog {
  id                  String   @id @default(uuid())
  organizerId         String?
  templateId          String?
  recipientEmail      String
  recipientName       String?
  subject             String
  status              EmailStatus
  providerMessageId   String?
  sentAt              DateTime?
  deliveredAt         DateTime?
  openedAt            DateTime?
  clickedAt           DateTime?
  bouncedAt           DateTime?
  errorMessage        String?  @db.Text
  metadata            Json?    // Variables used, links clicked, etc
  createdAt           DateTime @default(now())
  template            EmailTemplate? @relation(fields: [templateId], references: [id])
  organizer           Organizer? @relation(fields: [organizerId], references: [id])
  
  @@index([recipientEmail])
  @@index([status])
  @@index([createdAt])
}

